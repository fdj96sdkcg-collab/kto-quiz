<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kto? - Quiz dla pary</title>
    <!-- Import map for Firebase -->
    <script type="importmap">
        {
            "imports": {
                "firebase/app": "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js",
                "firebase/database": "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js"
            }
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 800px;
            width: 100%;
            text-align: center;
        }

        h1 {
            font-size: 100px;
            color: #667eea;
            margin-bottom: 20px;
            text-shadow: 5px 5px 0 #764ba2;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 24px;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            margin: 10px;
        }

        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.5);
        }

        .room-section {
            margin: 30px 0;
        }

        .room-input {
            padding: 15px;
            font-size: 18px;
            border: 2px solid #ddd;
            border-radius: 10px;
            width: 200px;
            margin-right: 10px;
        }

        .player-panel {
            display: none;
        }

        .question {
            font-size: 28px;
            margin: 30px 0;
            color: #333;
            font-weight: bold;
        }

        .options {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 30px 0;
        }

        .option-btn {
            background: #f0f0f0;
            border: 4px solid #ddd;
            padding: 40px;
            font-size: 64px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .option-btn:hover {
            border-color: #667eea;
            background: #e0e7ff;
            transform: scale(1.1);
        }

        .option-btn.selected {
            border-color: #667eea;
            background: #e0e7ff;
        }

        .waiting-screen {
            padding: 40px;
            background: #f8f9fa;
            border-radius: 15px;
            margin: 20px 0;
        }

        .waiting-animation {
            font-size: 48px;
            margin: 20px 0;
        }

        .compatibility {
            font-size: 72px;
            color: #4CAF50;
            font-weight: bold;
            margin: 20px 0;
        }

        .code-display {
            font-size: 48px;
            font-weight: bold;
            color: #667eea;
            background: #f0f0f0;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            letter-spacing: 10px;
        }

        .player-badge {
            font-size: 24px;
            padding: 10px 20px;
            border-radius: 10px;
            background: #667eea;
            color: white;
            display: inline-block;
            margin-bottom: 20px;
        }

        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            color: #f44336;
            background: #ffebee;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        /* Style dla podsumowania */
        .summary-container {
            max-height: 500px;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            margin: 20px 0;
        }

        .summary-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            border-bottom: 1px solid #ddd;
            gap: 10px;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-question {
            flex: 2;
            text-align: left;
            font-size: 14px;
            color: #333;
        }

        .answer-badge {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 12px;
            border-radius: 25px;
            font-size: 20px;
            min-width: 80px;
            justify-content: center;
        }

        .answer-p1 {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            color: #1976d2;
        }

        .answer-p2 {
            background: #fce4ec;
            border: 2px solid #e91e63;
            color: #c2185b;
        }

        .match-icon {
            font-size: 24px;
            min-width: 40px;
            text-align: center;
        }

        .match-good {
            color: #4CAF50;
        }

        .match-bad {
            color: #f44336;
        }

        .summary-stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 15px;
        }

        .stat-box {
            text-align: center;
        }

        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
        }

        .answer-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Ekran startowy -->
        <div id="startScreen">
            <h1>Kto?</h1>
            <div class="room-section">
                <h2 style="margin-bottom: 30px; color: #333;">Quiz dla pary na dw√≥ch urzƒÖdzeniach</h2>
                <button class="btn" id="createRoomBtn">Stw√≥rz nowy pok√≥j</button>
                <p style="margin: 20px 0; color: #666;">lub</p>
                <input type="text" id="roomCodeInput" class="room-input" placeholder="Kod pokoju" maxlength="6" autocomplete="off">
                <button class="btn" id="joinRoomBtn">Do≈ÇƒÖcz</button>
            </div>
            <div id="errorMessage" class="error-message" style="display: none;"></div>
        </div>

        <!-- Ekran oczekiwania -->
        <div id="waitingScreen" class="player-panel">
            <div class="player-badge" id="playerBadge">Gracz 1</div>
            <div class="waiting-screen">
                <h2 style="margin-bottom: 20px;">Tw√≥j kod pokoju:</h2>
                <div id="roomCode" class="code-display">123456</div>
                <div class="waiting-animation">‚è≥</div>
                <p style="font-size: 20px; color: #666;">Oczekiwanie na drugiego gracza...</p>
                <div class="loader"></div>
                <button class="btn" id="cancelRoomBtn" style="margin-top: 30px; background: #f44336;">Anuluj</button>
            </div>
        </div>

        <!-- Ekran gry -->
        <div id="gameScreen" class="player-panel">
            <div class="player-badge" id="gamePlayerBadge">Gracz 1</div>
            <div id="gameContent"></div>
        </div>

        <!-- Ekran wyniku ko≈Ñcowego -->
        <div id="finalResultScreen" class="player-panel">
            <div id="finalResultContent"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "firebase/app";
        import { getDatabase, ref, set, update, onValue, get, remove } from "firebase/database";

        // üî• TWOJA KONFIGURACJA FIREBASE üî•
        const firebaseConfig = {
            apiKey: "AIzaSyCbHpYsa13fpd_jypAB72otY0qYZDlUrk4",
            authDomain: "kto-quiz-404d9.firebaseapp.com",
            databaseURL: "https://kto-quiz-404d9-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "kto-quiz-404d9",
            storageBucket: "kto-quiz-404d9.firebasestorage.app",
            messagingSenderId: "472146697418",
            appId: "1:472146697418:web:3fcab7cdd39fd111f06833"
        };

        // Inicjalizacja Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        console.log("‚úÖ Firebase po≈ÇƒÖczony!");

        // üìã NOWE PYTANIA - 22 pytania
        const questions = [
            "Kto czƒô≈õciej sprzƒÖta?",
            "Kto czƒô≈õciej narzeka?",
            "Kto jest bardziej oszczƒôdny?",
            "Kto jest wiƒôkszym dusigroszem?",
            "Kto wiƒôcej m√≥wi?",
            "Kto wiƒôcej ≈õpi?",
            "Kto wiƒôcej m√≥wi o uczuciach?",
            "Kto pierwszy powiedzia≈Ç ¬´kocham ciƒô¬ª?",
            "Kto pierwszy napisa≈Ç?",
            "Kto jest bardziej leniwy?",
            "Kto lepiej gotuje?",
            "Kto czƒô≈õciej gra?",
            "Kto czƒô≈õciej pierdzi?",
            "Kto lepiej ta≈Ñczy?",
            "Kto lepiej ≈õpiewa?",
            "Kto jest lepiej zorganizowany?",
            "Kto jest bardziej kreatywny?",
            "Kto bardziej dba o rzeczy materialne?",
            "Kto siƒô lepiej opiekuje?",
            "Kto bardziej lubi je≈õƒá?",
            "Kto jest ≈õmieszniejszy?",
            "Kto jest bardziej powa≈ºny?"
        ];

        // Zmienne globalne
        let currentRoom = null;
        let playerNumber = null;
        let currentQuestionIndex = 0;
        let hasAnswered = false;
        let gameActive = false;
        let unsubscribeFunctions = [];

        // TABLICA DO PRZECHOWYWANIA WSZYSTKICH ODPOWIEDZI
        let answersHistory = [];

        // Generowanie kodu pokoju
        function generateRoomCode() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        // Czyszczenie nas≈Çuchiwa≈Ñ
        function clearListeners() {
            unsubscribeFunctions.forEach(fn => fn());
            unsubscribeFunctions = [];
        }

        // Tworzenie pokoju
        window.createRoom = async function() {
            try {
                const roomCode = generateRoomCode();
                currentRoom = roomCode;
                playerNumber = 1;
                answersHistory = []; // Reset historii odpowiedzi
                
                const roomRef = ref(database, `rooms/${roomCode}`);
                
                await set(roomRef, {
                    created: Date.now(),
                    player1: {
                        connected: true,
                        currentAnswer: null,
                        ready: false
                    },
                    player2: {
                        connected: false,
                        currentAnswer: null,
                        ready: false
                    },
                    gameState: {
                        currentQuestion: 0,
                        correctAnswers: 0,
                        status: 'waiting'
                    },
                    answers: [] // Tablica do przechowywania odpowiedzi w Firebase
                });
                
                document.getElementById('startScreen').style.display = 'none';
                document.getElementById('waitingScreen').style.display = 'block';
                document.getElementById('roomCode').textContent = roomCode;
                document.getElementById('playerBadge').textContent = 'Gracz 1 (Tw√≥rca)';
                
                // Nas≈Çuchuj na gracza 2
                const player2Ref = ref(database, `rooms/${roomCode}/player2/connected`);
                const unsubscribe = onValue(player2Ref, (snapshot) => {
                    if (snapshot.val() === true) {
                        document.getElementById('waitingScreen').style.display = 'none';
                        document.getElementById('gameScreen').style.display = 'block';
                        document.getElementById('gamePlayerBadge').textContent = 'Gracz 1 (Tw√≥rca)';
                        initializeGame();
                    }
                });
                unsubscribeFunctions.push(unsubscribe);
                
            } catch (error) {
                console.error("B≈ÇƒÖd tworzenia pokoju:", error);
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('errorMessage').textContent = '‚ùå Nie uda≈Ço siƒô utworzyƒá pokoju. Sprawd≈∫ po≈ÇƒÖczenie.';
            }
        };

        // Do≈ÇƒÖczanie do pokoju
        window.joinRoom = async function() {
            const roomCode = document.getElementById('roomCodeInput').value;
            if (!roomCode || roomCode.length < 6) {
                alert('Wprowad≈∫ poprawny 6-cyfrowy kod!');
                return;
            }
            
            try {
                currentRoom = roomCode;
                playerNumber = 2;
                answersHistory = []; // Reset historii odpowiedzi
                
                const roomRef = ref(database, `rooms/${roomCode}`);
                const snapshot = await get(roomRef);
                const room = snapshot.val();
                
                if (room && !room.player2.connected) {
                    await update(ref(database, `rooms/${roomCode}/player2`), {
                        connected: true,
                        currentAnswer: null,
                        ready: true
                    });
                    
                    await update(ref(database, `rooms/${roomCode}/gameState`), {
                        status: 'playing'
                    });
                    
                    document.getElementById('startScreen').style.display = 'none';
                    document.getElementById('gameScreen').style.display = 'block';
                    document.getElementById('gamePlayerBadge').textContent = 'Gracz 2';
                    
                    initializeGame();
                } else {
                    alert('Pok√≥j nie istnieje lub jest ju≈º zajƒôty!');
                }
            } catch (error) {
                console.error("B≈ÇƒÖd do≈ÇƒÖczania:", error);
                alert('Nie uda≈Ço siƒô do≈ÇƒÖczyƒá do pokoju. Sprawd≈∫ kod i spr√≥buj ponownie.');
            }
        };

        // Inicjalizacja gry
        function initializeGame() {
            gameActive = true;
            currentQuestionIndex = 0;
            hasAnswered = false;
            
            clearListeners();
            listenForGameUpdates();
            displayQuestion();
        }

        // Nas≈Çuchiwanie aktualizacji gry
        function listenForGameUpdates() {
            // Nas≈Çuchuj na zmianƒô pytania
            const questionRef = ref(database, `rooms/${currentRoom}/gameState/currentQuestion`);
            const questionUnsubscribe = onValue(questionRef, (snapshot) => {
                const newQuestion = snapshot.val();
                if (newQuestion !== null && newQuestion !== currentQuestionIndex) {
                    currentQuestionIndex = newQuestion;
                    hasAnswered = false;
                    displayQuestion();
                }
            });
            unsubscribeFunctions.push(questionUnsubscribe);
            
            // Nas≈Çuchuj na odpowiedzi przeciwnika
            if (playerNumber === 1) {
                const p2Ref = ref(database, `rooms/${currentRoom}/player2/currentAnswer`);
                const p2Unsubscribe = onValue(p2Ref, () => {
                    if (playerNumber === 1) checkBothAnswers();
                });
                unsubscribeFunctions.push(p2Unsubscribe);
            } else {
                const p1Ref = ref(database, `rooms/${currentRoom}/player1/currentAnswer`);
                const p1Unsubscribe = onValue(p1Ref, () => {
                    if (playerNumber === 2) checkBothAnswers();
                });
                unsubscribeFunctions.push(p1Unsubscribe);
            }
            
            // Nas≈Çuchuj na zako≈Ñczenie gry
            const statusRef = ref(database, `rooms/${currentRoom}/gameState/status`);
            const statusUnsubscribe = onValue(statusRef, (snapshot) => {
                if (snapshot.val() === 'finished') {
                    showFinalResult();
                }
            });
            unsubscribeFunctions.push(statusUnsubscribe);
        }

        // Wy≈õwietlanie pytania
        function displayQuestion() {
            if (currentQuestionIndex >= questions.length) {
                endGame();
                return;
            }
            
            hasAnswered = false;
            
            const content = document.getElementById('gameContent');
            content.innerHTML = `
                <div class="question">${questions[currentQuestionIndex]}</div>
                <p style="color: #666; margin-bottom: 10px;">Kliknij na swojƒÖ odpowied≈∫:</p>
                <div class="options">
                    <button class="option-btn" onclick="window.submitAnswer('dziewczyna', event)">üë©</button>
                    <button class="option-btn" onclick="window.submitAnswer('chlopak', event)">üë®</button>
                </div>
                <div id="answerStatus" style="margin-top: 20px; color: #666;">
                    ‚è≥ Wybierz odpowied≈∫...
                </div>
                <div class="progress">
                    Pytanie ${currentQuestionIndex + 1} z ${questions.length}
                </div>
            `;
        }

        // Wysy≈Çanie odpowiedzi
        window.submitAnswer = async function(answer, event) {
            if (hasAnswered || !gameActive) return;
            
            hasAnswered = true;
            
            const buttons = document.querySelectorAll('.option-btn');
            buttons.forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
            
            try {
                const playerRef = ref(database, `rooms/${currentRoom}/player${playerNumber}`);
                await update(playerRef, {
                    currentAnswer: answer,
                    ready: true
                });
                
                document.getElementById('answerStatus').innerHTML = '‚úÖ Odpowied≈∫ zapisana! Czekam na drugiego gracza...';
            } catch (error) {
                console.error("B≈ÇƒÖd zapisu odpowiedzi:", error);
                hasAnswered = false;
            }
        };

        // Sprawdzanie odpowiedzi obu graczy
        async function checkBothAnswers() {
            try {
                const roomRef = ref(database, `rooms/${currentRoom}`);
                const snapshot = await get(roomRef);
                const room = snapshot.val();
                
                if (!room) return;
                
                const p1Answer = room.player1?.currentAnswer;
                const p2Answer = room.player2?.currentAnswer;
                
                if (p1Answer && p2Answer) {
                    const sameAnswer = p1Answer === p2Answer;
                    
                    if (sameAnswer) {
                        const newScore = (room.gameState.correctAnswers || 0) + 1;
                        await update(ref(database, `rooms/${currentRoom}/gameState`), {
                            correctAnswers: newScore
                        });
                    }
                    
                    // ZAPISZ ODPOWIEDZI DO HISTORII
                    const answerRecord = {
                        question: questions[currentQuestionIndex],
                        questionIndex: currentQuestionIndex,
                        player1Answer: p1Answer,
                        player2Answer: p2Answer,
                        isMatch: sameAnswer
                    };
                    
                    // Dodaj do Firebase
                    const answersRef = ref(database, `rooms/${currentRoom}/answers/${currentQuestionIndex}`);
                    await set(answersRef, answerRecord);
                    
                    // Wyczy≈õƒá odpowiedzi
                    await update(ref(database, `rooms/${currentRoom}/player1`), { currentAnswer: null });
                    await update(ref(database, `rooms/${currentRoom}/player2`), { currentAnswer: null });
                    
                    // Nastƒôpne pytanie
                    const nextQuestion = currentQuestionIndex + 1;
                    if (nextQuestion < questions.length) {
                        await update(ref(database, `rooms/${currentRoom}/gameState`), {
                            currentQuestion: nextQuestion
                        });
                    } else {
                        endGame();
                    }
                }
            } catch (error) {
                console.error("B≈ÇƒÖd sprawdzania odpowiedzi:", error);
            }
        }

        // Zako≈Ñczenie gry
        async function endGame() {
            gameActive = false;
            try {
                await update(ref(database, `rooms/${currentRoom}/gameState`), {
                    status: 'finished'
                });
            } catch (error) {
                console.error("B≈ÇƒÖd ko≈Ñczenia gry:", error);
            }
        }

        // Wy≈õwietlanie wyniku ko≈Ñcowego
        async function showFinalResult() {
            try {
                const roomRef = ref(database, `rooms/${currentRoom}`);
                const snapshot = await get(roomRef);
                const room = snapshot.val();
                
                const gameState = room.gameState;
                const answers = room.answers || {};
                
                const correctAnswers = gameState?.correctAnswers || 0;
                const compatibility = Math.round((correctAnswers / questions.length) * 100);
                
                let message = '';
                if (compatibility >= 80) message = 'Jeste≈õcie sobie przeznaczeni! ‚ù§Ô∏è';
                else if (compatibility >= 60) message = 'Ca≈Çkiem nie≈∫le siƒô rozumiecie! üíë';
                else if (compatibility >= 40) message = 'Macie jeszcze trochƒô do poprawy üíï';
                else message = 'Pora lepiej siƒô poznaƒá! üíî';
                
                // Generuj podsumowanie odpowiedzi
                let summaryHtml = '';
                for (let i = 0; i < questions.length; i++) {
                    const answer = answers[i];
                    if (answer) {
                        const p1Emoji = answer.player1Answer === 'dziewczyna' ? 'üë©' : 'üë®';
                        const p2Emoji = answer.player2Answer === 'dziewczyna' ? 'üë©' : 'üë®';
                        const matchIcon = answer.isMatch ? '‚úÖ' : '‚ùå';
                        const matchClass = answer.isMatch ? 'match-good' : 'match-bad';
                        
                        summaryHtml += `
                            <div class="summary-item">
                                <div class="summary-question">${i+1}. ${answer.question}</div>
                                <div class="answer-row">
                                    <span class="answer-badge answer-p1">${p1Emoji}</span>
                                    <span class="answer-badge answer-p2">${p2Emoji}</span>
                                    <span class="match-icon ${matchClass}">${matchIcon}</span>
                                </div>
                            </div>
                        `;
                    }
                }
                
                document.getElementById('gameScreen').style.display = 'none';
                document.getElementById('finalResultScreen').style.display = 'block';
                
                document.getElementById('finalResultContent').innerHTML = `
                    <h2 style="font-size: 48px; margin-bottom: 20px; color: #333;">Wasz wynik!</h2>
                    <div class="compatibility">${compatibility}%</div>
                    <p style="font-size: 24px; margin-bottom: 30px; color: #666;">${message}</p>
                    
                    <div class="summary-stats">
                        <div class="stat-box">
                            <div class="stat-value">${correctAnswers}</div>
                            <div class="stat-label">Zgodnych</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${questions.length - correctAnswers}</div>
                            <div class="stat-label">Niezgodnych</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${questions.length}</div>
                            <div class="stat-label">Wszystkich</div>
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: center; gap: 30px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span class="answer-badge answer-p1">üë©/üë®</span>
                            <span style="color: #1976d2;">Gracz 1</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span class="answer-badge answer-p2">üë©/üë®</span>
                            <span style="color: #c2185b;">Gracz 2</span>
                        </div>
                    </div>
                    
                    <h3 style="font-size: 24px; margin: 30px 0 20px; color: #333;">Szczeg√≥≈Çowe odpowiedzi:</h3>
                    <div class="summary-container">
                        ${summaryHtml}
                    </div>
                    
                    <button class="btn" onclick="window.location.reload()" style="margin-top: 30px;">Zagraj ponownie</button>
                `;
            } catch (error) {
                console.error("B≈ÇƒÖd wy≈õwietlania wyniku:", error);
            }
        }

        // Anulowanie
        window.cancelRoom = async function() {
            if (currentRoom) {
                try {
                    await remove(ref(database, `rooms/${currentRoom}`));
                } catch (error) {
                    console.error("B≈ÇƒÖd usuwania pokoju:", error);
                }
            }
            window.location.reload();
        };

        // Inicjalizacja event listener√≥w
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('createRoomBtn').onclick = window.createRoom;
            document.getElementById('joinRoomBtn').onclick = window.joinRoom;
            document.getElementById('cancelRoomBtn').onclick = window.cancelRoom;
        });
    </script>
</body>
</html>
